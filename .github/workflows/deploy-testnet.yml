name: Deploy Testnet

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:

jobs:
  ci:
    uses: BreadchainCoop/etherform/.github/workflows/_ci.yml@main
    with:
      check-formatting: false

  check-approval:
    name: Check PR Approval
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'pull_request_review'
    outputs:
      approved: ${{ steps.check.outputs.approved }}
    steps:
      - name: Check if PR is approved
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [[ "${{ github.event_name }}" == "pull_request_review" && "${{ github.event.review.state }}" == "approved" ]]; then
            echo "approved=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            REVIEWS=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews --jq '[.[] | select(.state == "APPROVED")] | length')
            if [[ "$REVIEWS" -gt 0 ]]; then
              echo "approved=true" >> $GITHUB_OUTPUT
            else
              echo "approved=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "approved=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: [ci]
    uses: BreadchainCoop/etherform/.github/workflows/_deploy-testnet.yml@main
    secrets:
      PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
      RPC_URL: ${{ secrets.RPC_URL }}

  comment-on-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.event_name == 'pull_request' || github.event_name == 'pull_request_review'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download deployment artifacts
        uses: actions/download-artifact@v4
        with:
          path: deployments

      - name: Read network config
        id: network
        run: |
          BLOCKSCOUT_URL=$(jq -r '.testnets[0].blockscout_url' .github/deploy-networks.json)
          echo "blockscout_url=$BLOCKSCOUT_URL" >> $GITHUB_OUTPUT

      - name: Comment deployment to PR
        env:
          GH_TOKEN: ${{ github.token }}
          BLOCKSCOUT_URL: ${{ steps.network.outputs.blockscout_url }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.review.pull_request.number }}"

          DEPLOY_FILE=$(find deployments -name "deployment.json" -type f | head -1)
          if [[ -z "$DEPLOY_FILE" ]]; then
            echo "No deployment file found"
            exit 0
          fi

          COMMENT="## Testnet Deployment\n\n"
          COMMENT+="| Contract | Address | Explorer |\n"
          COMMENT+="|----------|---------|----------|\n"

          jq -r '.contracts[] | "\(.sourcePathAndName | split(":")[1]): \(.address)"' "$DEPLOY_FILE" | while read -r line; do
            CONTRACT=$(echo "$line" | cut -d: -f1)
            ADDRESS=$(echo "$line" | cut -d: -f2 | tr -d ' ')
            COMMENT+="| $CONTRACT | \`$ADDRESS\` | [View](${BLOCKSCOUT_URL}/address/$ADDRESS) |\n"
          done

          echo -e "$COMMENT" | gh pr comment "$PR_NUMBER" --body-file -
